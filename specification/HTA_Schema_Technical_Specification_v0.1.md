# HTA Schema Technical Specification
## Version 0.1 - Decision Tree Models

**Document Version:** 0.1.0  
**Date:** December 2024  
**Status:** Draft for Review  
**Author:** Peter McMeekin  

---

## 1. Executive Summary

This document specifies a universal JSON-based schema for representing Health Technology Assessment (HTA) economic models. Version 0.1 focuses on decision tree models as the foundational building block, with future versions extending to Markov models, time-to-event models, and microsimulations.

**Key Design Principles:**
- **Separation of concerns**: Structure, parameters, and results are distinct
- **Validation-first**: Models must be machine-validable for logical consistency
- **Modularity**: Components should be reusable across models
- **Extensibility**: Schema can grow without breaking existing models
- **Tool-agnostic**: Independent of any specific software implementation
- **Transparency**: Human-readable and machine-processable

---

## 2. Scope and Objectives

### 2.1 In Scope (v0.1)
- Decision tree structures with chance and decision nodes
- Cost and utility outcome specifications
- Deterministic and probabilistic parameter definitions
- Basic discounting and time horizons
- Incremental cost-effectiveness analysis (ICEA)
- One-way and multi-way sensitivity analysis specifications

### 2.2 Out of Scope (v0.1, planned for future versions)
- Markov cohort models
- Time-to-event models
- Discrete event simulations
- Individual patient simulations
- Value of information calculations (EVPI/EVPPI)
- Model calibration specifications

### 2.3 Objectives
1. Enable complete specification of decision tree models in JSON format
2. Support validation of model structure and parameters
3. Facilitate model sharing and peer review
4. Enable automated execution and result generation
5. Support sensitivity analysis specifications

---

## 3. Schema Architecture

### 3.1 Top-Level Structure

Every HTA Schema model contains these top-level sections:

```json
{
  "schema_version": "0.1.0",
  "model_metadata": { ... },
  "model_structure": { ... },
  "parameters": { ... },
  "analysis_settings": { ... }
}
```

Note: **Results are not stored in the schema file**. They are generated by execution engines and returned separately.

### 3.2 Schema Version Management

The `schema_version` field uses semantic versioning:
- **Major version** (X.0.0): Breaking changes, incompatible models
- **Minor version** (0.X.0): New features, backward compatible
- **Patch version** (0.0.X): Bug fixes, clarifications

Parsers MUST validate against the specified schema version.

---

## 4. Model Metadata

Captures essential information about the model for documentation and provenance.

### 4.1 Required Fields

| Field | Type | Description |
|-------|------|-------------|
| `model_id` | string (UUID) | Unique identifier for this model |
| `model_name` | string | Human-readable model name |
| `model_type` | enum | One of: "decision_tree", "markov", "tte", "microsim" |
| `created_date` | ISO 8601 datetime | When model was first created |
| `modified_date` | ISO 8601 datetime | Last modification timestamp |
| `author` | object | Author information |
| `description` | string | Brief model description |

### 4.2 Optional Fields

| Field | Type | Description |
|-------|------|-------------|
| `version` | string | Model version (separate from schema version) |
| `keywords` | array[string] | Search/categorization keywords |
| `clinical_area` | string | Disease/intervention area |
| `target_population` | string | Population description |
| `comparators` | array[string] | List of interventions compared |
| `setting` | string | Healthcare setting (e.g., "UK NHS", "US payer") |
| `currency` | string (ISO 4217) | Currency code (e.g., "GBP", "USD") |
| `currency_year` | integer | Year for cost data |
| `references` | array[object] | Academic citations |
| `license` | string | Data license (e.g., "CC-BY-4.0") |
| `data_sources` | array[object] | Links to input data sources |

### 4.3 Example

```json
{
  "model_metadata": {
    "model_id": "550e8400-e29b-41d4-a716-446655440000",
    "model_name": "Stroke Thrombolysis Decision Tree",
    "model_type": "decision_tree",
    "created_date": "2024-12-01T10:00:00Z",
    "modified_date": "2024-12-12T14:30:00Z",
    "author": {
      "name": "Dr. Jane Smith",
      "affiliation": "University Hospital",
      "email": "j.smith@example.ac.uk",
      "orcid": "0000-0002-1234-5678"
    },
    "description": "Cost-effectiveness of thrombolysis vs. standard care in acute ischemic stroke",
    "version": "1.2",
    "clinical_area": "Stroke",
    "target_population": "Adults with acute ischemic stroke presenting within 4.5 hours",
    "comparators": ["IV thrombolysis", "Standard care"],
    "setting": "UK NHS",
    "currency": "GBP",
    "currency_year": 2024,
    "keywords": ["stroke", "thrombolysis", "alteplase", "cost-effectiveness"]
  }
}
```

---

## 5. Decision Tree Structure

### 5.1 Core Concepts

A decision tree consists of:
- **Nodes**: Decision points, chance events, or terminal outcomes
- **Branches**: Connections between nodes with associated probabilities (for chance nodes)
- **Outcomes**: Terminal nodes with cost and utility payoffs

### 5.2 Node Types

#### 5.2.1 Decision Node
Represents a choice between interventions or strategies.

```json
{
  "node_id": "decision_1",
  "node_type": "decision",
  "label": "Treatment Choice",
  "description": "Initial treatment decision",
  "branches": [
    {
      "branch_id": "branch_1",
      "label": "Intervention A",
      "target_node": "chance_1",
      "initial_cost": {"parameter_ref": "intervention_a_cost"}
    },
    {
      "branch_id": "branch_2", 
      "label": "Standard Care",
      "target_node": "chance_2",
      "initial_cost": {"parameter_ref": "standard_care_cost"}
    }
  ]
}
```

**Fields:**
- `node_id`: Unique identifier within model
- `node_type`: Must be "decision"
- `label`: Display name
- `description`: Optional longer description
- `branches`: Array of decision options

**Branch Fields:**
- `branch_id`: Unique identifier for this branch
- `label`: Branch display name
- `target_node`: ID of the next node
- `initial_cost`: Optional immediate cost associated with this choice

#### 5.2.2 Chance Node
Represents probabilistic events.

```json
{
  "node_id": "chance_1",
  "node_type": "chance",
  "label": "Treatment Response",
  "description": "Patient response to intervention",
  "branches": [
    {
      "branch_id": "branch_3",
      "label": "Success",
      "probability": {"parameter_ref": "success_prob"},
      "target_node": "outcome_1"
    },
    {
      "branch_id": "branch_4",
      "label": "Failure", 
      "probability": {"parameter_ref": "failure_prob"},
      "target_node": "outcome_2"
    }
  ]
}
```

**Additional Branch Fields for Chance Nodes:**
- `probability`: Parameter reference for branch probability
- Probabilities for all branches from a chance node MUST sum to 1.0

#### 5.2.3 Terminal Node (Outcome)
Represents final health states with associated costs and utilities.

```json
{
  "node_id": "outcome_1",
  "node_type": "terminal",
  "label": "Full Recovery",
  "description": "Patient returns to full health",
  "outcomes": {
    "costs": [
      {
        "category": "treatment",
        "value": {"parameter_ref": "treatment_cost"},
        "timing": "immediate"
      },
      {
        "category": "follow_up",
        "value": {"parameter_ref": "followup_cost"},
        "timing": "annual",
        "duration_years": {"parameter_ref": "time_horizon"}
      }
    ],
    "utilities": [
      {
        "value": {"parameter_ref": "full_health_utility"},
        "timing": "annual",
        "duration_years": {"parameter_ref": "time_horizon"}
      }
    ],
    "life_years": {"parameter_ref": "life_expectancy_healthy"}
  }
}
```

**Outcome Fields:**
- `costs`: Array of cost components
- `utilities`: Array of utility values over time
- `life_years`: Expected life years (for QALY calculation)

**Cost/Utility Timing Options:**
- `immediate`: One-time cost/utility at this point
- `annual`: Recurring yearly for specified duration
- `one_time_at`: Occurs once at specified time point

### 5.3 Tree Structure Requirements

**Validation Rules:**
1. Every tree must have exactly one decision node as root
2. All node IDs must be unique
3. All branch target_nodes must reference existing nodes
4. All branches from a chance node must have probabilities that sum to 1.0
5. Terminal nodes cannot have outgoing branches
6. No cycles are permitted (it's a tree, not a graph)
7. Every path must eventually reach a terminal node

---

## 6. Parameters

Parameters separate the model structure from its inputs, enabling sensitivity analysis and uncertainty quantification.

### 6.1 Parameter Definition Structure

```json
{
  "parameters": {
    "parameter_id": {
      "name": "Human-readable name",
      "description": "Detailed description",
      "type": "probability|cost|utility|rate|relative_risk|duration",
      "base_value": <number>,
      "distribution": { ... },
      "bounds": {
        "lower": <number>,
        "upper": <number>
      },
      "source": "Citation or data source",
      "notes": "Additional context"
    }
  }
}
```

### 6.2 Parameter Types

| Type | Description | Valid Range |
|------|-------------|-------------|
| `probability` | Probability of event | [0.0, 1.0] |
| `cost` | Monetary value | [0.0, ∞) |
| `utility` | Health state utility | [-1.0, 1.0] typical, can extend |
| `rate` | Event rate (per unit time) | [0.0, ∞) |
| `relative_risk` | Ratio of risks | (0.0, ∞) |
| `duration` | Time period | [0.0, ∞) |

### 6.3 Distributions for PSA

For probabilistic sensitivity analysis, parameters can have associated distributions:

```json
{
  "distribution": {
    "family": "beta|gamma|lognormal|normal|uniform",
    "parameters": {
      "alpha": 10,
      "beta": 90
    }
  }
}
```

**Supported Distributions:**

| Family | Parameters | Typical Use |
|--------|------------|-------------|
| `beta` | alpha, beta | Probabilities, utilities |
| `gamma` | shape, scale | Costs (right-skewed) |
| `lognormal` | mu, sigma | Relative risks, costs |
| `normal` | mean, sd | General purpose (truncate if needed) |
| `uniform` | lower, upper | Non-informative priors |

### 6.4 Parameter Example

```json
{
  "parameters": {
    "success_prob": {
      "name": "Treatment Success Probability",
      "description": "Probability of successful recanalization with thrombolysis",
      "type": "probability",
      "base_value": 0.45,
      "distribution": {
        "family": "beta",
        "parameters": {
          "alpha": 45,
          "beta": 55
        }
      },
      "bounds": {
        "lower": 0.30,
        "upper": 0.60
      },
      "source": "NINDS 1995 (doi:10.1056/NEJM199512143332401)",
      "notes": "Based on 90-day mRS 0-1 outcomes"
    },
    "intervention_cost": {
      "name": "Thrombolysis Drug Cost",
      "description": "Cost of alteplase including administration",
      "type": "cost",
      "base_value": 450.00,
      "distribution": {
        "family": "gamma",
        "parameters": {
          "shape": 100,
          "scale": 4.5
        }
      },
      "bounds": {
        "lower": 300.00,
        "upper": 600.00
      },
      "source": "NHS Reference Costs 2024"
    }
  }
}
```

---

## 7. Analysis Settings

Specifies how the model should be executed and analyzed.

### 7.1 Base Case Analysis

```json
{
  "analysis_settings": {
    "base_case": {
      "time_horizon": 10,
      "time_horizon_units": "years",
      "cycle_length": 1.0,
      "cycle_length_units": "years",
      "discount_rate_costs": 0.035,
      "discount_rate_outcomes": 0.035,
      "half_cycle_correction": false,
      "perspective": "healthcare_system"
    }
  }
}
```

**Fields:**
- `time_horizon`: Duration of analysis
- `discount_rate_costs`: Annual discount rate for costs (e.g., 0.035 = 3.5%)
- `discount_rate_outcomes`: Annual discount rate for QALYs
- `perspective`: One of: "healthcare_system", "societal", "payer"

### 7.2 Sensitivity Analysis Specifications

```json
{
  "sensitivity_analyses": [
    {
      "analysis_id": "sa_1",
      "name": "One-way SA on success probability",
      "type": "one_way",
      "parameter": "success_prob",
      "values": [0.30, 0.35, 0.40, 0.45, 0.50, 0.55, 0.60]
    },
    {
      "analysis_id": "sa_2",
      "name": "Threshold analysis on WTP",
      "type": "threshold",
      "parameter": "willingness_to_pay",
      "range": [0, 50000],
      "step": 1000
    },
    {
      "analysis_id": "psa_1",
      "name": "Probabilistic Sensitivity Analysis",
      "type": "probabilistic",
      "iterations": 10000,
      "random_seed": 42,
      "parameters": "all_with_distributions"
    }
  ]
}
```

---

## 8. Complete Example: Simple Decision Tree

See accompanying file `example_decision_tree.json` for a complete working example.

---

## 9. Validation Requirements

### 9.1 Structural Validation

Validators MUST check:

1. **Schema conformance**: File matches JSON Schema definition
2. **Node connectivity**: All references resolve to existing nodes
3. **Tree properties**: No cycles, single root, all paths terminate
4. **Probability constraints**: Chance node branches sum to 1.0 (within tolerance)
5. **Parameter references**: All parameter_ref values exist in parameters section
6. **Type consistency**: Parameter types match their usage (e.g., probabilities used for branch probabilities)

### 9.2 Semantic Validation

Validators SHOULD check:

1. **Parameter ranges**: Values within sensible bounds for their type
2. **Cost reasonableness**: Negative costs flagged (with option to allow)
3. **Utility ranges**: Typically [-0.5, 1.0] for health utilities
4. **Distribution parameters**: Valid for specified distribution family
5. **Discount rates**: Typically [0.0, 0.10] for health economics

### 9.3 Tolerance Settings

For floating-point comparisons:
- Default tolerance: 1e-6
- Probability sum tolerance: 1e-4 (to allow for rounding)

---

## 10. Execution Model

### 10.1 Deterministic Execution

Process:
1. Start at root decision node
2. For each branch from decision node:
   - Follow all chance node paths using base_value probabilities
   - Calculate expected costs and QALYs by backward induction
   - Apply discounting based on time_horizon and discount rates
3. Compare strategies: calculate incremental costs and QALYs
4. Compute ICER for each dominated strategy

### 10.2 Probabilistic Execution

Process:
1. For each PSA iteration:
   - Draw random samples from all parameter distributions
   - Execute deterministic model with sampled parameters
   - Store iteration results (costs, QALYs, ICER)
2. Analyze PSA results:
   - Generate cost-effectiveness plane
   - Calculate cost-effectiveness acceptability curves (CEAC)
   - Estimate confidence intervals

---

## 11. Extension Points

Version 0.1 includes extension points for future capabilities:

### 11.1 Custom Node Types

Future versions may support:
- Markov state nodes
- Time-to-event nodes
- Patient attribute nodes (for microsimulation)

### 11.2 Parameter Relationships

Future versions may support:
- Calculated parameters (functions of other parameters)
- Correlation structures for PSA
- Time-varying parameters

### 11.3 Advanced Outcomes

Future versions may support:
- Multiple outcome dimensions (QALYs, LYs, clinical endpoints)
- Equity weights
- Budget impact calculations

---

## 12. Reference Implementation

A reference implementation will be provided that:
- Validates models against this specification
- Executes deterministic and probabilistic analyses
- Generates standard outputs (ICER tables, CE planes, tornado diagrams)
- Provides Python and R APIs

Implementation repository: [To be determined]

---

## 13. Governance and Version Control

### 13.1 Schema Evolution

Changes to the schema follow this process:
1. Proposal submitted via GitHub issue
2. Community discussion period (minimum 30 days)
3. Technical working group review
4. Acceptance requires majority approval
5. Implementation in reference validator

### 13.2 Backward Compatibility

- Patch versions: Must be fully backward compatible
- Minor versions: May add optional fields but cannot change existing required fields
- Major versions: May introduce breaking changes with migration path

---

## Appendix A: JSON Schema Definition

See `hta_schema_v0.1.json` for the formal JSON Schema definition.

---

## Appendix B: Comparison to Existing Formats

| Feature | HTA Schema | TreeAge | Excel | R (heemod) |
|---------|------------|---------|-------|------------|
| Structured format | ✓ JSON | ✗ Binary | ✗ Complex | ✓ R lists |
| Version control friendly | ✓ | ✗ | ✗ | ✓ |
| Human readable | ✓ | ✗ | Partial | ✓ |
| Machine validatable | ✓ | ✗ | ✗ | Partial |
| Tool independent | ✓ | ✗ | ✓ | ✗ |
| Standard distribution | ✓ | ✓ | ✗ | ✓ |

---

## Document History

| Version | Date | Changes |
|---------|------|---------|
| 0.1.0 | 2024-12-12 | Initial draft - decision trees only |

---

**Contact:**  
For questions or suggestions regarding this specification, please contact: [contact email to be added]

**License:**  
This specification document is licensed under Creative Commons Attribution 4.0 International (CC BY 4.0).
The specification itself is free to implement without restriction.
